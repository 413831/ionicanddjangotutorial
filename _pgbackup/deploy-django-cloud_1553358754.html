<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Deploy a Django project on cloud using Clever-Cloud - Ionic and Django Tutorial</title>
        <meta name="description" content="On this second tutorial, we will learn how to deploy our django application on cloud using the Clever cloud services."/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125461829-1');
</script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <style>.mySlides {
    display: none;
}</style>
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="index.html" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <section> 
                        <header class="major"> 
                            <h1>Deploy our Django project on cloud</h1>
                            <b>DAY 2 - October 2018</b>
                        </header>                         
                        <span class="image main"></span> 
                        <div> 
                            <p>
				 In our <a href="./design-and-setup.html" alt="Tutorial django project setup" target="_blank">previous tutorial</a>, we learn to setup our django project.
				 In this tutorial, we will polishing our django admin interface and then deploy it into the cloud. <br>As reminder, all source code could be find <a href="https://github.com/csurbier/ionicanddjangotutorial" target="_blank">on my Github repository</a> <br> <br>
				 Using <a href="https://www.clever-cloud.com/en/" alt="Clever cloud" target="_blank">Clever Cloud</a> service, it is really easy to deploy the django project.
				 You just need to declare which services you will use and they take care of all the ops work stuff. Then you can just focus on your business 
				 and deploy your code using GIT commands. <br>
				 So to begin, create an account (it's free and they give you 20 â‚¬ which is quite enough to test and develop your project), and then follow these steps: <ol>
                                    <li>Create an application</li>
                                    <li>Choose your scaling mode : to develop we can choose a 
                                        <b>nano instance</b>
                                    </li>
                                    <li>Named your app and choose your zone (Paris or Montreal)</li>
                                    <li>Add an add-on to your apps : FS Buckets (it is like an Amazon S3), your files will be stored on it</li>
                                    <li>Add another add-on : Our PostgreSQL database. You can choose the development one</li>
                                    <li>Link your PostgreSQL add-on to your application</li>
                                    <li>Send a message to Clever cloud support to ask them activate the 
                                        <b>Postgis extension</b> for your PostgreSQL database. Don't worry, they are very reactive. 
                                </ol>
				 And that's it, you have fully functionnal architecture, quite simple isn't it ?
				 Here are the screenshots of these steps:  </p>
                            <div class="w3-content w3-display-container">
                                <img class="mySlides" src="images/clever/step1.png" style="height:50%" alt="deploy django in cloud step 1">
                                <img class="mySlides" src="images/clever/step2.png" style="height:50%" alt="deploy django in cloud step 2">
                                <img class="mySlides" src="images/clever/step3.png" style="height:50%" alt="deploy django in cloud step 3">
                                <img class="mySlides" src="images/clever/step4.png" style="height:50%" alt="deploy django in cloud step 4">
                                <img class="mySlides" src="images/clever/step5.png" style="height:50%" alt="deploy django in cloud step 5">
                                <img class="mySlides" src="images/clever/step6.png" style="height:50%" alt="deploy django in cloud step 6">
                                <img class="mySlides" src="images/clever/step7.png" style="height:50%" alt="deploy django in cloud step 7">
                                <img class="mySlides" src="images/clever/step8.png" style="height:50%" alt="deploy django in cloud step 8">
                                <img class="mySlides" src="images/clever/step9.png" style="height:50%" alt="deploy django in cloud step 9">
                                <img class="mySlides" src="images/clever/step10.png" style="height:50%" alt="deploy django in cloud step 10">
                                <img class="mySlides" src="images/clever/step11.png" style="height:50%" alt="deploy django in cloud step 11">
                                <button class="w3-button w3-black w3-display-left" onclick="plusDivs(-1)">&#10094;</button>
                                <button class="w3-button w3-black w3-display-right" onclick="plusDivs(1)">&#10095;</button>
                            </div>
                            <script>
var slideIndex = 1;
showDivs(slideIndex);

function plusDivs(n) {
  showDivs(slideIndex += n);
}

function showDivs(n) {
  var i;
  var x = document.getElementsByClassName("mySlides");
  if (n > x.length) {slideIndex = 1}    
  if (n < 1) {slideIndex = x.length}
  for (i = 0; i < x.length; i++) {
     x[i].style.display = "none";  
  }
  x[slideIndex-1].style.display = "block";  
}
</script>
                            <br>
                            <p>
			Now before deploying on the cloud, we will test our application on our local machine. In our <b>bikebackend</b> directory, we create a <b>static</b> directory,
			for our static files. Inside this directory we create another <b>static</b> directory and a <b>storage</b> directory. The <b>static</b> directory will contains all
			the static files, and the <b>storage</b> directory, our logs files and user files (like uploaded image from our application...). <br>
			Then we need the libraries to use PostgreSQL with Django. In our <b>requirements.txt</b> we add :</p>
                            <pre><code>django==2.1
psycopg2-binary==2.7.4
pillow==5.1.0</code></pre>
                            <p><ul>
                                    <li>psycopg2-binary : is the python PostgreSQL driver</li>
                                    <li>pillow : is our image library</li>
                                </ul> 
By specifying version you want to use, you will avoid problems in the future, if the library evolves and breaks your code. <br>Install the new libraries with:</p>
                            <pre><code>pip3 install -r requirements.txt</code></pre>
                            <p>
			Finally, we need to configure our Django app to indicate our database connection, our static repository... 
			Edit the <b>settings.py</b> file located in <b>bikebackend/bikebackend</b> directory and add the following lines: </p>
                            <pre><code>
POSTGRESQL_ADDON_URI = os.getenv("POSTGRESQL_ADDON_URI")
POSTGRESQL_ADDON_PORT = os.getenv("POSTGRESQL_ADDON_PORT")
POSTGRESQL_ADDON_HOST = os.getenv("POSTGRESQL_ADDON_HOST")
POSTGRESQL_ADDON_DB = os.getenv("POSTGRESQL_ADDON_DB")
POSTGRESQL_ADDON_PASSWORD = os.getenv("POSTGRESQL_ADDON_PASSWORD")
POSTGRESQL_ADDON_USER = os.getenv("POSTGRESQL_ADDON_USER")
STATIC_URL_PREFIX  = os.getenv("STATIC_URL_PREFIX")
MEDIA_ROOT=os.getenv("APP_HOME")+os.getenv("STATIC_URL_PREFIX")+'/storage/'
MEDIA_URL = os.getenv('STATIC_URL_PREFIX')+"/storage/"
STATIC_ROOT = os.getenv("APP_HOME")+os.getenv("STATIC_URL_PREFIX")+'/static/static/' </code></pre>
                            <p>Then replace the database lines with our PostgreSQL version:</p>
                            <pre><code>
DATABASES = {
    'default': {
        'ENGINE': 'django.contrib.gis.db.backends.postgis', #''django.db.backends.postgresql_psycopg2',  #'django.db.backends.mysql',
        'NAME': POSTGRESQL_ADDON_DB,
        'USER': POSTGRESQL_ADDON_USER,
        'PASSWORD': POSTGRESQL_ADDON_PASSWORD,
        'HOST': POSTGRESQL_ADDON_HOST,
        'PORT': POSTGRESQL_ADDON_PORT,
        'CONN_MAX_AGE': 5, 
    }
}</code></pre>
                            <p>First we are getting and settings variables from environment values, because this is the way Clever Cloud works. It will inject the correct values at runtime.
 This is quite standard/usual way to do so. <br>As PostgreSQL engine, we will use the <b>Postgis extension</b> because we will have to deal with geolocation objects/queries (Remember our IONIC application is about
	finding Bikes around users.) <br><br>
	So to be able to run and test the django project on your local machine, you need to setup these environment variables with correct values. You can get the PostgreSQL values,
	on your Clever cloud PostgreSQL add-on dashboard: </p>
                            <pre><code>Credentials
Host	XXXXXXX-postgresql.services.clever-cloud.com
Database	XXXXXX
User	XXXXXX
Port	5432 (default)
Password	XXXXXX
Connection URI	postgresql://XXXX:XXXXXXX.services.clever-cloud.com:5432/XXXX</code></pre>
                            <p>
Usually i create a <b>varEnv.txt</b> file on my machine (inside the <b>bikebackend</b> directory) with the values:</p>
                            <pre><code>export POSTGRESQL_ADDON_URI=postgresql://XXXXXXX:XXXXXXX@XXXXXXX-postgresql.services.clever-cloud.com:5432/XXXXXXX
export POSTGRESQL_ADDON_PORT=5432
export POSTGRESQL_ADDON_HOST=XXXXXXX-postgresql.services.clever-cloud.com
export POSTGRESQL_ADDON_DB=XXXXXXX
export POSTGRESQL_ADDON_PASSWORD=XXXXXXX
export APP_HOME=/home/csurbier/Documents/Tutorial/Backend/bikebackend/
export STATIC_URL_PREFIX=/static
export POSTGRESQL_ADDON_USER=XXXXXXX</code></pre>
                            <p>
Just replace the <b>XXXXXXX</b> with your correct value and set the <b>APP_HOME</b> with your correct path. Then you can launch the commands in your terminal,
to export the values. <br>Another way is to add these values to your django environment directory (the one we created with the <b>virtualenv</b> command). Just add these lines at the end
of your <b>/bin/activate</b> file.<br>
 Now we are ready to create our database models (please refer to <a href="./design-and-setup.html" alt="Tutorial django project setup" target="_blank">tutorial one</a>).
 If Clever cloud answered to you and have activated the <b>Postgis extension</b> then you can launch (from the <b>bikebackend</b> root directory):</p>
                            <pre><code>python3 manage.py makemigrations
python3 manage.py migrate</code></pre>
                            <p>To access our backoffice, we need to create a superuser:</p>
                            <pre><code>python3 manage.py createsuperuser</code></pre>
                            <p>
You will have to enter the email with which you want to authenticate and the password (please note that since we override the django User model, we only require an email).<br>Run your django project:</p>
                            <pre><code>python3 manage.py runserver</code></pre>
                            <p>If everything is ok you should see when launching your browser at : http://127.0.0.1:8000/</p>
                            <span class="image object"><img src="images/django-running.png" alt="Django running"/></span>
                            <p><br>
To access the backoffice use the url : http://127.0.0.1:8000/admin/ and enter your email, password that you have choosen. The access will be denied :(.
What's happening ? <br>
In the <b>User</b> model we define the field: <b>is_staff = models.BooleanField(('staff'), default=False)</b> with a default false value.<br><b>is_staff</b> is the variable used by Django to check if a user is able to access to the Backoffice or not. And since we don't want our future users of our IONIC application,
to access the backoffice (security issue if they found or guess our admin interface), we set the value to false.<br><br>To correct the issue, just update your database table (which should contain at the moment only one row : the superuser we created) with the following command: </p>
                            <pre><code>update backoffice_user set is_staff=True</code></pre>
                            <p>
 You can use any PostgreSQL client to run the SQL command or the Clever Cloud PostgreSQL database manager interface. <br>
 Now if you try again to login to the admin interface, it should be successful and you should be able to manage the User and Bike models. </p>
                            <span class="image object"><img src="images/django-admin.png" alt="Django admin"/></span>
                            <p><br> <br> <ul class="pagination"> 
                                    <li>
                                        <a href="#" class="page active">1</a>
                                    </li>                                     
                                    <li>
                                        <a href="deploy-django-cloud-part2.html" class="button">Next</a>
                                    </li>                                     
                                </ul> </p> 
                        </div>
                    </section>                     
                </div>
            </div>             
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="index.html">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <div id="disqus_thread"></div>
        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Backend, Frontend and Mobile App Programming Tutorial",
      "description": "All programming technologies that build complete web or mobile apps discover here. They are Backend (Java, Grails, NodeJS), Database (NoSQL, RDBMS), Frontend (HTML5, CSS3, Javascript, AngularJS, Bootstrap, ReactJS, Sass), Mobile App (Android, iOS, Ionic Framework, React Native) developments",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>