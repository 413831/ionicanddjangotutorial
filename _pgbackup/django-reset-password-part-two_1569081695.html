<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Reset password link with Django - Part two</title>
        <meta name="description" content="Learn how to send a reset password link with django from your ionic application - Part two - Ionic and Django Tutorial"/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125461829-1');
</script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <style>.mySlides {
    display: none;
}</style>
        <style>.responsiveimage {
    width: 100%;
    height: auto;
}</style>
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="/" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <section> 
                        <header class="major"> 
                            <h1>Send reset password link with Ionic and Django - Part two</h1>
                            <b>August 2019</b>
                        </header>                         
                        <span class="image main"></span> 
                        <div>
                            <h2>Reset password link in Django</h2>
                            <p>
                                First thing to do is to declare our url to receive the password reset demand. To do this, we modify the <b>urls.py</b> file in our <b>bikebackend</b> directory to add: </p>
                            <pre><code>path('account/reset_password', sendPasswordLink, name="reset_password"),</code></pre>
                            <p>
                                Which means that when the <i>account/reset_password</i> url is called, Django will execute the <b>sendPasswordLink</b> method. This method will be declare in a new directory that we will create to manage the full functionnality of reseting password. The full <b>urls.py</b> file should be: </p>
                            <pre> <code>from django.contrib import admin
from django.urls import path
from django.conf.urls import include
from django.conf import settings
from django.conf.urls.static import static
from rest_framework.routers import DefaultRouter
from resetpassword.utils.views import sendPasswordLink
router = DefaultRouter()
urlpatterns = [
    path('', include(router.urls)),
    path('jet/', include('jet.urls', 'jet')),  # Django JET URLS
    path('admin/', admin.site.urls),
    path('api/', include('api.urls')),
    path('doc/', include('rest_framework_docs.urls')),
    path('o/', include('oauth2_provider.urls')),
    path('account/reset_password', sendPasswordLink, name="reset_password"),
]+ static(settings.STATIC_URL, document_root=settings.STATIC_ROOT) </code></pre>
                            <p>
                                So we are going to create this <b>resetpassword</b> package. At the root of our bikebackend project, we create a new directory named <b>resetpassword</b> and inside the directory, we create an empty file <b>__init__.py</b> because we want it to be interpreted as a python package. </p>
                            <pre><code>mkdir resetpassword
cd resetpassword
touch __init__.py </code></pre>
                            <p>
                                Then inside our directory we will create a new python directory named <b>utils</b> which will contains our python code </p>
                            <pre><code>mkdir utils
touch utils/__init__.py
touch utils/views.py</code></pre>
                            <p>
                                Now we can create our  <b>sendPasswordLink</b> method inside the <b>views.py</b> file. </p>
                            <pre><code>@csrf_exempt
def sendPasswordLink(request):
    if request.method == "POST":
        data = request.POST['email_or_username']
        associated_users = User.objects.filter(email=data)
        try:
         if associated_users.exists():
                for user in associated_users:
                    reset_password(user, request)
                return HttpResponse(status=200)
        except Exception as e:
                print(e)
        return HttpResponse(status=404)
    else:
        return HttpResponse(status=404)</code></pre>
                            <p>
                                Before our method we write the <b>@csrf_exempt</b> annotation because our data is coming from a post request sent by our Ionic application. There is no need of CSRF django protection (more info <a href="https://docs.djangoproject.com/en/2.2/ref/csrf/" target="_blank">about CRSF</a>)<br>
                                Then we get the email sent from the ionic application, in the post request and we verify if we can find a user in our database with the provided email. If a user is found, we can send him the requested link for resetting his password, otherwise we send back an http error 404 to our ionic application.  </p>
                            <pre><code>def reset_password(user, request):
    c = {
        'email': user.email,
        'domain': request.META['HTTP_HOST'],
        'site_name': 'bikebackend',
        'uid': urlsafe_base64_encode(force_bytes(user.pk)).decode('utf-8'),
        'user': user,
        'token': default_token_generator.make_token(user),
        'protocol': 'http',
    }
    subject_template_name = 'registration/password_reset_subject.txt'
    email_template_name = 'registration/password_reset_email.html'
    subject = loader.render_to_string(subject_template_name, c)
    # Email subject *must not* contain newlines
    subject = ''.join(subject.splitlines())
    email = loader.render_to_string(email_template_name, c)
    try:
        to_email = Email(user.email)
        from_email = Email("contact@bikebackend.fr")
        content = Content('text/html', email)
        message = Mail(from_email, subject, to_email, content)
        sg = sendgrid.SendGridAPIClient(apikey=SENDGRID_API_KEY)
        sg.client.mail.send.post(request_body=message.get())
    except Exception as e:
        print(e.message)</code></pre>
                            <p>
                                The <b>reset_password</b> method will generate a unique token to add it in the link that we will sent.<br> The subject of the email will use the defaut django contrib admin file <b>registration/password_reset_subject.txt</b> and we will override the default <b>registration/password_reset_email.html</b> file to add our own content.<br> <br>To send the email, we will use the <b><a href="https://sendgrid.com/" target="_blank">sendgrid</a> </b> services and more particulary the python sdk (the <b>SENDGRID_API_KEY</b> will be declare in our <b>settings.py</b> file)<br>We don't forget to add <b>sendgrid</b> to our <b>requirements.txt</b> file</p>
                            <pre><code>django>=2.0.11
psycopg2==2.7 --no-binary psycopg2
pillow==5.1.0
django-jet
djangorestframework
django-filter
git+https://github.com/mago960806/django-rest-framework-docs.git
django-oauth-toolkit
django-cors-middleware
sendgrid</code></pre>
                            <p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- IonicDjangoBloc2 --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins><script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script> </p>
                            <p>
                                Here is the full <b>views.py</b> file (with import) </p>
                            <pre><code># -*-coding:utf-8 -*-
from django.contrib.auth.tokens import default_token_generator
from django.utils.encoding import force_bytes
from django.utils.http import urlsafe_base64_encode
from django.template import loader
from bikebackend.settings import SENDGRID_API_KEY
from backoffice.models import User
from django.http import HttpResponse
import sendgrid
from django.views.decorators.csrf import csrf_exempt
from sendgrid.helpers.mail import Mail,Email,Content
def reset_password(user, request):
    c = {
        'email': user.email,
        'domain': request.META['HTTP_HOST'],
        'site_name': 'bikebackend',
        'uid': urlsafe_base64_encode(force_bytes(user.pk)).decode('utf-8'),
        'user': user,
        'token': default_token_generator.make_token(user),
        'protocol': 'http',
    }
    subject_template_name = 'registration/password_reset_subject.txt'
    email_template_name = 'registration/password_reset_email.html'
    subject = loader.render_to_string(subject_template_name, c)
    # Email subject *must not* contain newlines
    subject = ''.join(subject.splitlines())
    email = loader.render_to_string(email_template_name, c)
    try:
        to_email = Email(user.email)
        from_email = Email("contact@bikebackend.fr")
        content = Content('text/html', email)
        message = Mail(from_email, subject, to_email, content)
        sg = sendgrid.SendGridAPIClient(apikey=SENDGRID_API_KEY)
        sg.client.mail.send.post(request_body=message.get())
    except Exception as e:
        print(e.message)
@csrf_exempt
def sendPasswordLink(request):
    if request.method == "POST":
        data = request.POST['email_or_username']
        associated_users = User.objects.filter(email=data)
        try:
         if associated_users.exists():
                for user in associated_users:
                    reset_password(user, request)
                return HttpResponse(status=200)
        except Exception as e:
                print(e)
        return HttpResponse(status=404)
    else:
        return HttpResponse(status=404)</code></pre>
                            <p>
                                We need to create our <b>registration/password_reset_email.html</b> file. This file must be created inside a <b>templates</b> directory inside our <b>resetpassword</b> directory </p>
                            <pre><code>mkdir templates
mkdir templates/registration
touch templates/registration/password_reset_email.html</code></pre>
                            <p>
                                And our html file will contains : </p>
                            <pre><code>{% load i18n %}{% autoescape off %}
Hi,
&#x3C;br&#x3E;&#x3C;br&#x3E;
You are receiving this email because of your reset password request.
&#x3C;br&#x3E;&#x3C;br&#x3E;
Please go to this page and choose a new password:
    {% block reset_link %}
        http://{{ domain }}/account/reset_password_confirm/{{uid}}/{{token}}
    {% endblock %}
&#x3C;br&#x3E;&#x3C;br&#x3E;
The BikeBackend Team
{% endautoescape %}</code></pre>
                            <p>
                                Inside our html file, we are getting the values passed our django context declared in our views. With these values we are able to create a dynamic link on which the user will have to click to go and choose a new password.<br>
                                So now we need to define this new url in our <b>urls.py</b> file </p>
                            <pre><code>re_path(&#x27;account/reset_password_confirm/(?P&#x3C;uidb64&#x3E;[0-9A-Za-z]+)/(?P&#x3C;token&#x3E;.+)&#x27;,PasswordResetConfirmView.as_view(), name=&#x27;password_reset_confirm&#x27;)</code></pre>
                            <p>  </p>
                            <pre><code>
class PasswordResetConfirmView(FormView):
    template_name = "account/pwdoublie.html"
    success_url = '/account/pwdenvoye'
    form_class = SetPasswordForm
    def post(self, request, uidb64=None, token=None, *arg, **kwargs):
        """
        View that checks the hash in a password reset link and presents a
        form for entering a new password.
        """
        form = self.form_class(request.POST)
        assert uidb64 is not None and token is not None  # checked by URLconf
        try:
            uid = urlsafe_base64_decode(uidb64)
            user = User.objects.get(pk=uid)
        except (TypeError, ValueError, OverflowError, User.DoesNotExist):
            user = None
        if user is not None and default_token_generator.check_token(user, token):
            if form.is_valid():
                new_password = form.cleaned_data['confirmation']
                user.password = hashlib.sha256(new_password.encode('utf8')).hexdigest()
                user.save()
                messages.success(request, 'Your password has been modified')
                return self.form_valid(form)
            else:
                print(form.errors)
                messages.error(request, form.errors)
                return self.form_invalid(form)
        else:
            messages.error(
                request, 'This link has expired.')
            return self.form_invalid(form)</code></pre>
                        </div>
                    </section>
                    <ul class="pagination"> 
                        <li>
                            <a href="django-reset-password.html" class="button">Previous</a>
                        </li>
                        <li>
                            <a href="#" class="page active">2</a>
                        </li>                         
                    </ul>
                </div>
            </div>
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="/">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <div id="disqus_thread"></div>
        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Ionic and Django tutorial",
      "description": "A tutorial to learn mobile application development from scratch and on a concrete use case, using Ionic 4 as frontend and Django as backend.",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>