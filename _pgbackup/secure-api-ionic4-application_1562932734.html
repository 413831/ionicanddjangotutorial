<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Secure WebService in Ionic 4 application with oAuth</title>
        <meta name="description" content="Learn how to secure your API with oAuth in a Ionic 4 application - Ionic and Django Tutorial"/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-125461829-1');
</script>
        <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
        <style>.mySlides {
    display: none;
}</style>
        <style>.responsiveimage {
    width: 100%;
    height: auto;
}</style>
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="/" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <section> 
                        <header class="major"> 
                            <h1>Secure Ionic 4 API with oAuth</h1>
                            <b>DAY 4 - July 2019</b>
                        </header>                         
                        <span class="image main"></span> 
                        <div>
                            <p>
                            In our previous <a href="https://www.ionicanddjangotutorial.com/oauth-with-django-rest-framework.html" target="_blank">tutorial</a> we learned how to secure an API in our Django project. In this tutorial, we will see how to call our secure API from our Ionic 4 project. </p>
                            <h2>
                                Get an oAuth2 at Ionic 4 application launches  </h2>
                            <p>
                                Each time our ionic application is launched, first thing we need to do is to check if we have an oAuth2 token and if not create one. </p>
                            <pre><code>import { Component } from '@angular/core';
import { Platform } from '@ionic/angular';
import { SplashScreen } from '@ionic-native/splash-screen/ngx';
import { StatusBar } from '@ionic-native/status-bar/ngx';
import {ApiDjangoService} from '../app/services/api-django.service'
@Component({
  selector: 'app-root',
  templateUrl: 'app.component.html'
})
export class AppComponent {
  constructor(
    private platform: Platform,
    private splashScreen: SplashScreen,
    private statusBar: StatusBar,
    public apiService : ApiDjangoService
  ) {
    this.initializeApp();
  }
  accessAuthorizedWithUrl(){
  }
  getToken(){
  } 
  initializeApp() {
    this.platform.ready().then(() => {
      this.statusBar.styleDefault();
      this.splashScreen.hide();
      // check if we have a token to use API
      this.apiService.checkOauthToken().then((result) => {
        if (result){
          console.log("Deja token "+result);
          this.accessAuthorizedWithUrl()
        }
        else { 
          console.log("PAS DE TOKEN TOKEN")
          this.getToken()
        }
      });
    });
  }
} </code></pre>
                            <p> <ul>
                                    <li>First we import our 
                                        <a href="https://www.ionicanddjangotutorial.com/create-api-service-between-ionic-and-django.html" target="_blank"><b>ApiDjangoService</b></a> and inject it in our 
                                        <b>AppComponent</b> constructor
                                    </li>
                                    <li>Then once the platform is ready, we are going to call a 
                                        <b>apiService.checkOauthToken()</b> to check if we have a token or not
                                    </li>
                                    <li>If we have a token, it's perfect we can continue and go to 
                                        <b>accessAuthorizedWithUrl</b> function.
                                    </li>
                                    <li>If we don't have a token, we are going to ask one</li>
                                </ul> 
                            Since we want to save our token in our application storage, we will need the <a href="https://ionicframework.com/docs/building/storage" target="_blank"><b>Ionic Storage</b></a> library, so to install it: </p>
                            <pre><code>ionic cordova plugin add cordova-sqlite-storage
npm install --save @ionic/storage </code></pre>
                            <p>
                            Then we modify our <b>AppComponent</b> class to include it. </p>
                            <pre><code>import { Component } from '@angular/core';
import { Storage } from '@ionic/storage';
import { Platform } from '@ionic/angular';
import { SplashScreen } from '@ionic-native/splash-screen/ngx';
import { StatusBar } from '@ionic-native/status-bar/ngx';
import { ApiDjangoService } from '../app/services/api-django.service'
@Component({
  selector: 'app-root',
  templateUrl: 'app.component.html'
})
export class AppComponent {
  constructor(
    private platform: Platform,
    private splashScreen: SplashScreen,
    private statusBar: StatusBar,
    public apiService: ApiDjangoService,
    public storage : Storage
  ) {
    this.initializeApp();
  }
  accessAuthorizedWithUrl() {
  }
  getToken() {
    console.log("Pas deja token ")
    this.apiService.checkOauthToken().then((token) => {
      if (token) {
        console.log("Retour WS token "+token+" on sauve token en local "+token)
        this.accessAuthorizedWithUrl()
      }
      else {
        // Get token
        this.apiService.getOAuthToken().then((token) => {
          if (token) {
            console.log("Retour WS token "+token+" on sauve token en local "+token)
            this.accessAuthorizedWithUrl()
          }
          else {
              console.log("ERREUR RETOUR TOKEN"); 
          }
        });
      }
    });
  }
  initializeApp() {
    this.platform.ready().then(() => {
      this.statusBar.styleDefault();
      this.splashScreen.hide();
      // check if we have a token to use API
      this.apiService.checkOauthToken().then((result) => {
        if (result) {
          console.log("ACCESS DIRECT  Deja token " + result);
          this.accessAuthorizedWithUrl()
        }
        else {
          console.log("ACCESS DIRECT PAS DE TOKEN TOKEN")
          this.getToken()
        }
      });
    });
  }
}</code></pre>
                            <p>
                            Now the <b>getToken()</b> method has been modified, and ask our <b>apiService</b> to know if we have a token or not. If not, it means our application will not be able to work properly since we will not be able to call our django protected API.  </p>
                            <p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- IonicDjangoBloc2 --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins><script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script> </p>
                            <h2>
                            Update our Api service provider to implement the oAuth2 token verification </h2>
                            <p>
                              In our <b>apiSevice</b> we will implement the method <b>getOAuthToken()</b> which will call our django backend.  </p>
                            <pre><code>getOAuthToken() {
    let url = this.getOauthUrl
    console.log("pas de token appel WS url avec nouveau headers " + url);
    let body = 'client_id=' + this.oAuth2ClientId + '&client_secret=' + this.oAuth2ClientSecret + '&username=' + this.oAuth2Username + '&password=' + this.oAuth2Password + '&grant_type=password';
    //console.log("body "+body);
    const httpOptions = {
      headers: new HttpHeaders({
        'content-type': "application/x-www-form-urlencoded",
      })
    };
    return new Promise(resolve => {
      this.http.post(url, body, httpOptions)
        .pipe(
          retry(1)
        )
        .subscribe(res => {
          let token = res["access_token"];
          this.tokenSSO = token
          console.log("ok TOKEN " + token);
          let expireIn = res["expires_in"]; // Secondes
          this.expireDate = (Date.now() / 1000) + expireIn;
          // Save expireDate
          this.storage.set(this.appName + '_expireAccessToken', this.expireDate);
          this.storage.set(this.appName + '_accessToken', this.tokenSSO).then((result) => {
              resolve(token)
          })
        }, error => {
          console.log("ERREUR APPEL TOKEN ");// Error getting the data
          console.log(error)
          resolve()
        });
    });
  }</code></pre>
                            <p> <ul>
                                    <li>We construct the url to call by adding to it the paramaters required to get be authentified.</li>
                                    <li>Then we call our Django oAuth2 webservice and get the results</li>
                                    <li>We extract the received token from the response and save it to local storage</li>
                                    <li>If you remember, a token can be limited in time and expire, so we get the expiry time of the token, and add it to the current date, to know the date of the expiration. Then we save the results in the local storage</li>
                                </ul> </p>
                            <p>
                        Now we can implement the method <b>checkOauthToken</b>, which will look up into the local storage if we have a token or not. </p>
                            <pre><code>
                            checkOauthToken() {
    console.log("on check OAUTH TOKEN");
    return new Promise(resolve => {
      this.storage.get(this.appName + '_accessToken').then((result) => {
        console.log("OK CHECK TOKEN " + result);
        if (result) {
          this.tokenSSO = result
          // Set expire date
          let expireFS = this.getExpireDate().subscribe((date) => {
            // check date expire
            expireFS.unsubscribe()
            let now = Date.now() / 1000;
            console.log("on compare " + this.expireDate + " avec " + now);
            if (Number(this.expireDate) &lt; now) {
              console.log("date expirée, on va chercher nouveau token")
              resolve()
            }
            else {
              resolve(result)
            }
          })
        }
        else {
          resolve()
        }
      });
    });
  } </code></pre>
                        </div>
                    </section>
                </div>
            </div>
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="/">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <div id="disqus_thread"></div>
        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Ionic and Django tutorial",
      "description": "A tutorial to learn mobile application development from scratch and on a concrete use case, using Ionic 4 as frontend and Django as backend.",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>