<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Sign in with Apple in Ionic application - part 2</title>
        <meta name="description" content="In this tutorial, i will show you how to implement sign in with Apple with Ionic 4 - Part 2."/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125461829-1');
</script>         
        <style>.responsiveimage {
    width: auto;
    height: 100%;
}</style>
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="index.html" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <!-- Content -->                     
                    <section> 
                        <header class="main"> 
                            <h1>Implement Sign in with Apple in Ionic 4 application - Part 2</h1>
                            <b>October 2019</b>
                        </header>                         
                        <span class="image main"></span> 
                        <p>
                            We have seen that to implement <b>sign in with Apple</b> we have a lot of things to configure before. </p>
                        <ol>
                            <li>Configure our apple developer account</li>
                            <li>Configure our Django backend to let apple verify our domain</li>
                            <li>Configure our Django backend to let apple send user information</li>
                            <li>Configure our Django backend to search and retrieve user information</li>
                        </ol>
                        <p>
                        Now we will focus on the Ionic implementation code. </p>
                        <h2>
                            Sign in with Apple into your Ionic 4 application </h2>
                        <p>
                          First thing to do which is obvious, is to add a "Sign in with Apple" button on our ionic register page.<br>You can use an image or create a standard dark button like this: </p>
                        <pre><code>&#x3C;ion-button mode=&#x22;md&#x22; expand=&#x22;block&#x22; color=&#x22;dark&#x22; (click)=&#x22;doAppleLogin()&#x22;&#x3E;
          &#x3C;ion-icon slot=&#x22;start&#x22; class=&#x22;sw-Apple&#x22;&#x3E;&#x3C;/ion-icon&#x3E; Continuer avec Apple
        &#x3C;/ion-button&#x3E;</code></pre>
                        <p>
                            In the click action, we define a <b>doAppleLogin()</b> method, so let's code this method  </p>
                        <pre><code>doAppleLogin() {
this.userManager.loginWithApple=true
let state = Math.random().toString(36);
this.userManager.loginWithApple_state = state;
let redirectUri = encodeURI(&#x22;https://backend.swiitchvtc.com/api/signin_with_apple/&#x22;)
let urlParams = &#x22;?client_id=com.swiitch.webapp&#x26;redirect_uri=&#x22;+redirectUri+&#x22;&#x26;response_type=code%20id_token&#x26;scope=name%20email&#x26;response_mode=form_post&#x26;state=&#x22;+state
let url = &#x22;https://appleid.apple.com/auth/authorize&#x22;+ urlParams;
let target = &#x22;_system&#x22;
this.inAppBrowser.create(url, target, &#x22;location=no,zoom=no&#x22;)
}</code></pre>
                        <ol>
                            <li>First we use our 
                                <b>UserManagerProviderService</b> to set a flag on it, to keep the trace that we are asking the Apple sign in
                            </li>
                            <li>Then we generate a random state parameter and save it also in our 
                                <b>UserManagerProviderService</b>
                            </li>
                            <li>We set the params for the Apple auth url:
                                <ul>
                                    <li>
                                        <b>client_id:</b> The one we configured as services id on our developer account (com.swiitch.webapp)
                                    </li>
                                    <li>
                                        <b>redirect_uri:</b> The endpoint we added in our Django backend and configured on our developer account
                                    </li>
                                    <li>
                                        <b>response_type:</b> Please provide code and id_token otherwise you will received an error from Apple server 
                                    </li>
                                    <li>
                                        <b>scope:</b>Â We want the name and email of the user
                                    </li>
                                    <li>
                                        <b>response_mode:</b> form_post (since we want to receive parameters as a post request)
                                    </li>
                                    <li>
                                        <b>state:</b> Our generated identifier that we will use to retrieve the information sent by Apple
                                    </li>
                                </ul>
                            </li>
                            <li> We launch a new browser (using ionic InAppBrowser plugin) outside our ionic application by calling the url we just constructed
</li>
                        </ol>
                        <p>
                     	If everything is ok, your user should be redirected in a browser and next actions will be managed by Apple. You should see a webpage for "Sign in with Apple" and then a popup asking you to identicate.     </p>
                        <img src="images/signinwithapple/example_signin_with_apple_1.PNG" class="responsiveimage"/>
                        <img src="images/signinwithapple/example_signin_with_apple_2.PNG" class="responsiveimage"/>
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        <!-- IonicDjangoBloc2 -->
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
                        <p>
                            As you can see when sign in the user can choose to share his real email or to create a fake email that will be manage by Apple.<br>
                            These values (email and name) are those that you will receive. </p>
                        <p>
                            At this stage, if everything goes well (meaning developer account is setup successfully and same for our Django backend), we should have a new line in our database in our <b>AppleSignin</b> model and our application user should see a page in his browser asking me to go back to the Ionic application. </p> 
                        <p>
                            If the user goes back to the Ionic application, we should be able to detect it and do some appropriate actions to react to this event. Best place to do this, is in our <b>app.component.ts</b> file. We will check if application is resume from background and if it is because of an apple sign in event (remember the flag we set previously in our UserManagerProviderService): </p>
                        <pre><code> //Subscribe on resume
      this.platform.resume.subscribe(() =&#x3E; {
        console.log(&#x22;===========================&#x22;)
        console.log(&#x22;Resume from background ?&#x22;) 
        if (this.userManager.loginWithApple){
          console.log(&#x22;loginFromApple &#x22;+this.userManager.loginWithApple)
          console.log(&#x22;loginFromAppleState &#x22;+this.userManager.loginWithApple_state)
          this.userManager.checkAppleLogin().then((success)=&#x3E;{
            if (success){
              this.authentificationService.authenticationState.next(true)
              this.userConnected=true;
              this.authentified()
              this.task = setInterval(() =&#x3E; {
                this.checkAPIAndMessage();
              }, 10000);
            }
          })
        } 
      });</code></pre>
                        <p>
                            When platform is resuming (meaning coming back from background state), we check if it is because of an apple signin event by checking our previously set flag.<br>
                            if so, we call a method <b>this.userManager.checkAppleLogin()</b> and since it is a promise, we analyse the status when returned. <br>
                            On success, our user is authenticated and we can continue the process in our application, such as going to home page, ... (it's up to you). </p>
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        <!-- IonicDjangoBloc2 -->
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
                        <p>
                         Let's finish this tutorial by implementing the most important method <b>checkAppleLogin()</b> which will get the user information from our backend and then register the user (if it doesn't already exists) or login the user.    </p>
                        <pre><code>checkAppleLogin(){
    return new Promise(resolve =&#x3E; {
    this.apiService.showLoading()
    this.apiService.searchAppleSignin(this.loginWithApple_state).subscribe((results)=&#x3E;{
      this.apiService.stopLoading()
      this.loginWithApple=false;
      console.log(results)
      if (results){
        let data = results[&#x22;results&#x22;]
        if (data){
          let firstFind = data[0]
          let id_token = firstFind[&#x22;token&#x22;]
          let jsonUser= firstFind[&#x22;jsonUser&#x22;]
          //parse json
          let jsonConverted = JSON.parse(jsonUser)
          let email=jsonConverted[&#x22;email&#x22;]
          let name = jsonConverted[&#x22;name&#x22;]
          if (email){
            let firstName = name[&#x22;firstName&#x22;]
            // create profil and login 
            let connectionType = 0;
            if (this.platform.is(&#x22;ios&#x22;)){
              connectionType = 0
            }
            else{
              connectionType = 1
            }
            let params = {
              &#x22;email&#x22;:email,
              &#x22;firstName&#x22;:firstName,
              &#x22;password&#x22;: CryptoJS.SHA256(name).toString(CryptoJS.enc.Hex),
              &#x22;connectionType&#x22;:connectionType,
              &#x22;appleId&#x22;:id_token
            }
            this.apiService.createUser(params).subscribe((result) =&#x3E; {
              this.apiService.stopLoading();
              if (result) {
                this.setUser(result)
                resolve(true)
              }
              else {
                this.apiService.showError(&#x22;D&#xE9;sol&#xE9; une erreur technique est survenue, impossible de cr&#xE9;er votre compte&#x22;)
                resolve(false)
              }
            })
          }
          else{
            //Search existing User
            this.apiService.showLoading()
            this.apiService.findUserByAppleId(id_token).subscribe((results)=&#x3E;{
              console.log(results)
              this.apiService.stopLoading(); 
                if (results){
                  let count = results[&#x22;count&#x22;]
                  console.log(&#x22;Count &#x22;+count)
                  if (count==0){
                    this.apiService.showMessage(&#x22;D&#xE9;sol&#xE9;&#x22;,&#x22;Identification Apple &#xE9;chou&#xE9;e&#x22;)
                    resolve(false)
                  }
                  else{
                    let result = results[&#x22;results&#x22;][0]
		    this.setUser(result)
                    resolve(true)
                  }
                }
            })
          }
        }
        else{
          this.apiService.showMessage(&#x22;D&#xE9;sol&#xE9;&#x22;,&#x22;Erreur technique, identification Apple impossible&#x22;)
          resolve(false)
        }
      }
      else{
        this.apiService.showMessage(&#x22;D&#xE9;sol&#xE9;&#x22;,&#x22;Erreur technique, identification Apple impossible&#x22;)
        resolve(false)
      }
    })
    })
  }</code></pre>
                        <p>
                            This method is implemented in our <b>UserManagerProviderService</b> so we can get directly the <b>state</b> identifier that we created earlier to asks our django backend to retrieve the information for this parameter. This is the goal of the method <b>this.apiService.searchAppleSignin(this.loginWithApple_state)</b> </p>
                        <pre><code>searchAppleSignin(state) {
        const options = {
            headers: new HttpHeaders({
                &#x27;Authorization&#x27;: &#x27;Bearer &#x27; + this.tokenSSO,
                &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
            })
        };
        return Observable.create(observer =&#x3E; {
            // At this point make a request to your backend to make a real check!
            console.log(&#x22;on appelle BACKEND encoded url &#x22; + this.getAppleSignInUrl);
            this.http.get(this.getAppleSignInUrl+&#x22;?state=&#x22;+state, options)
                .pipe(retry(1))
                .subscribe(res =&#x3E; {
                    observer.next(res);
                    observer.complete();
                }, error =&#x3E; {
                    observer.next();
                    observer.complete();
                    console.log(error);// Error getting the data
                });
        });
    }</code></pre>
                        <p>
                    	The promise will return a <b>results</b> object. If this object is empty, something goes wrong and we display an error message. (Apple sign in has failed or an error occurs in the django backend)<br>    						If we have a results object, we extract the data located in the <b>results</b> json field. (<i>Please remember we are getting values from Django Rest API which return a specific json format</i>) <br>
                        Then from our data variable, we get the first index object since data is an array of values sorted by descending creation date. <br><br>
                        Then we get the <b>id_token</b> which is the unique apple user id<br>
                        and the <b>jsonUser</b> which contains (or not) the user informations (email,name). <br>So we parse the <b>jsonUser</b> and check if an email is provided. <br>If so, we have the user information from Apple, and we can create our user in our backend (register him) <br>If not provided, it means the user had already signin once into our application (if he logout and try to login again), and so we try to get our user by searching by his unique identifier (id_token). If we find him, we can login to our application, otherwise we need to display a login error. </p>
                    </section>                     
                    <ul class="pagination"> 
                        <li>
                            <a href="ionic-signin-with-apple.html" class="button">Previous</a>
                        </li>                         
                        <li>
                            <a href="#" class="page active">2</a>
                        </li>                         
                    </ul>                     
                    <section>
                        <div id="disqus_thread"></div>
                        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
                    </section>
                </div>
            </div>             
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="index.html">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Ionic and Signin with Apple",
      "description": "Learn to implement signin with Apple with Ionic",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>