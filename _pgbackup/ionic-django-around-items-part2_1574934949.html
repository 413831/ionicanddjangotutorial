<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Display items around user with Ionic and Django - Part two</title>
        <meta name="description" content="In this tutorial, i will show you how to get items around you based on geolocation and how to display them on a google map inside a Ionic 4 application. this is the part two of the tutorial"/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125461829-1');
</script>         
        <style>.responsiveimage {
    width: 100%;
    height: auto;
}</style>
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="index.html" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <!-- Content -->                     
                    <section> 
                        <header class="main"> 
                            <h1>Display geolocated items on a google map with Ionic</h1>
                            <b>November 2019</b>
                        </header>                         
                        <span class="image main"></span> 
                        <p> </p>
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        <!-- IonicDjangoBloc2 -->
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
                        <p>
                            Ok to display our bikes on a google map, we need to add a new ionic page that we will call : ShowBikes </p>
                        <pre><code>ionic g page ShowBikes</code></pre>
                        <p>
                            and as usual, we will move the new directory created <b>show-bikes</b> into the <b>pages</b> directory, and adapt the <b>app-routing.mobule.ts</b> file to reflect the change </p>
                        <pre><code>{ path: 'show-bikes', loadChildren: './pages/show-bikes/show-bikes.module#ShowBikesPageModule' }</code></pre>
                        <p>
                            Now we want to geolocate our user to be able to call our new django api endpoint. So we need to install some <a href="https://ionicframework.com/docs/native/geolocation" target="_blank">new plugins</a> and <a href="https://ionicframework.com/docs/native/location-accuracy" target="_blank">this</a> to our ionic application </p>
                        <pre><code>ionic cordova plugin add cordova-plugin-geolocation
npm install @ionic-native/geolocation
ionic cordova plugin add cordova-plugin-request-location-accuracy
npm install @ionic-native/location-accuracy</code></pre>
                        <p>
                            next modify our <b>app.module.ts</b> to import and initialize this library </p>
                        <pre><code>import { Geolocation } from &#x27;@ionic-native/geolocation/ngx&#x27;;
import { LocationAccuracy } from &#x27;@ionic-native/location-accuracy/ngx&#x27;;
@NgModule({
  declarations: [AppComponent],
  entryComponents: [],
  imports: [BrowserModule,
     IonicModule.forRoot(), 
     IonicStorageModule.forRoot(),
     HttpClientModule,
     AppRoutingModule],
  providers: [
    StatusBar,
    SplashScreen,
    Network,
    { provide: RouteReuseStrategy, useClass: IonicRouteStrategy },
    ApiDjangoService,
    Geolocation,
    LocationAccuracy
  ],
  bootstrap: [AppComponent]
})
export class AppModule {}</code></pre>
                        <p>
                            We added the <b>Geolocation</b> module into the providers list.<br>
                            Now we can edit our <b>show-bikes.pages.ts</b> to import some of the libraries that we will need </p>
                        <pre><code>import { Component, OnInit } from &#x27;@angular/core&#x27;;
import { Geolocation,Geoposition } from &#x27;@ionic-native/geolocation/ngx&#x27;;
import { Platform } from &#x27;@ionic/angular&#x27;;
import { ApiDjangoService } from &#x27;../../services/api-django.service&#x27;;
import { Router } from &#x27;@angular/router&#x27;;
import { LocationAccuracy } from &#x27;@ionic-native/location-accuracy/ngx&#x27;;
@Component({
  selector: &#x27;app-show-bikes&#x27;,
  templateUrl: &#x27;./show-bikes.page.html&#x27;,
  styleUrls: [&#x27;./show-bikes.page.scss&#x27;],
})
export class ShowBikesPage implements OnInit {
  constructor(public geolocation: Geolocation,
    public apiService: ApiDjangoService,
    public platform : Platform,
    public locac : LocationAccuracy,
    public router: Router) { 
    }
  ngOnInit() {
  }
}</code></pre>
                        <p>
                            If you remember the tutorial for login and registering users, we do nothing after logged in or registered successfully. It is time to redirect the end user to this new page <b>show-bikes</b> </p>
                        <pre><code>this.router.navigateByUrl("/show-bikes")</code></pre>
                        <p>
                            Ok now we need to write the method <b>geoloc</b> which will geolocate the user </p>
                        <pre><code>geoloc() {
    return new Promise(resolve =&#x3E; {
      if (this.platform.is(&#x27;cordova&#x27;)) {
        let options = {
          enableHighAccuracy: true,
          maximumAge:0,
          timeout:10000
        };
        console.log(&#x22;------  PLATFORM CORDOVA&#x22;);
        this.locac.request(this.locac.REQUEST_PRIORITY_HIGH_ACCURACY).then(() =&#x3E; {
          this.geolocation.getCurrentPosition(options).then((position: Geoposition) =&#x3E; {
            console.log(&#x22;============= POSITION  ================&#x22;);
            console.log(position)
            resolve(position);
          }).catch((err) =&#x3E; {
            console.log(&#x22;Error GEOLOC &#x22; + JSON.stringify(err))
            resolve(false)
          })
        });
      }
      else{
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            position =&#x3E; {
              console.log(&#x22;============= POSITION  ================&#x22;);
              console.log(position)
              //Hardcoded 
              resolve(position);
            },
            error =&#x3E; {
              resolve(false);
            }
          );
        }
      }
    })
  }</code></pre>
                        <p>First, we check if user is on a mobile or using a browser.
                            On mobile, we can use the <b>LocationAccuracy</b> to get from the device the best accuracy possible, and then we ask the device to get it's current position.  <br>Otherwise we use the <strong>navigator.geolocation</strong> method to get the position<br><br>We can now call this method on our constructor </p>
                        <pre><code>constructor(public geolocation: Geolocation,
    public apiService: ApiDjangoService,
    public platform : Platform,
    public locac : LocationAccuracy,
    public router: Router) {
      this.apiService.showLoading()
      this.geoloc().then((position)=&#x3E;{
      	  this.apiService.stopLoading()
          this.positionUser = position
           if (position){
            this.displayData()
          }
          else{
            this.apiService.showError("Sorry unable to geolocate")
          }
      })   
    }</code></pre>
                        <p>
                            If we have a position we call our django backend api to get bikes around otherwise we display a message to the user that is position has not been retrieved. </p>
                        <p>
                            Let's write our api method to retrieve bikes from backend </p>
                        <pre><code>
getBikesAround(latitude,longitude){
  const options = {
    headers: new HttpHeaders({
      &#x27;Authorization&#x27;: &#x27;Bearer &#x27; + this.tokenSSO,
      &#x27;Content-Type&#x27;: &#x27;application/json&#x27;
    })
  };
  // distance is 1000 Km for example, please modify to your requirements
  let url = this.getBikesAroundUrl+&#x22;?latitude=&#x22;+latitude+&#x22;&#x26;longitude=&#x22;+longitude+&#x22;&#x26;max_distance=1000&#x22;
  return Observable.create(observer =&#x3E; {
    // At this point make a request to your backend  
    this.http.get(url, options)
      .pipe(retry(1))
      .subscribe(res =&#x3E; {
        observer.next(res);
        observer.complete();
      }, error =&#x3E; {
        observer.next();
        observer.complete();
        console.log(error);// Error getting the data
      });
  });
}</code></pre>
                        <p>
                            Ok now before writing our <b>displayData()</b> method, we will configure our Ionic project to be able to use Google maps.<br>You need to have a valid <a href="https://developers.google.com/maps/documentation/javascript/get-api-key" target="_blank">Google Map Api Key</a>, have activated the maps library in your console, then you need to add this API KEY in your <b>index.html</b> file  </p>
                        <pre><code>
  &#x3C;script src=&#x22;https://maps.googleapis.com/maps/api/js?v=3&#x26;key=YOURAPIKEY;libraries=maps&#x22;&#x3E;&#x3C;/script&#x3E;
  &#x3C;script src=&#x22;https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js&#x22;&#x3E;&#x3C;/script&#x3E;</code></pre>
                        <p>
                            I have also included the <a href="https://developers.google.com/maps/documentation/javascript/marker-clustering" target="_blank">markercluster javascript library</a> because we will group our bikes using cluster. The idea is to avoid displaying a lot of bikes on the map, and to group them. Please consult the MarkerCluster api documentation, to better understand the concept. </p>
                        <p>
                            Now we will add the import and new variables needed in our ionic code. </p>
                        <pre><code>import { Component, OnInit,ViewChild } from &#x27;@angular/core&#x27;;
import { ElementRef } from &#x27;@angular/core&#x27;;
...
export class ShowBikesPage implements OnInit {
  positionUser : any;
  bikesList : any;
  markersBike : any;
  markerCluster : any; 
  @ViewChild(&#x27;map&#x27;) mapElement: ElementRef;
  map: any;</code></pre>
                        <p>
                            We will write our html  </p>
                        <pre><code>&#x3C;ion-header&#x3E;
  &#x3C;ion-toolbar&#x3E;
    &#x3C;ion-title&#x3E;ShowBikes&#x3C;/ion-title&#x3E;
  &#x3C;/ion-toolbar&#x3E;
&#x3C;/ion-header&#x3E;
&#x3C;ion-content&#x3E;
  &#x3C;div #map id=&#x22;map&#x22; class=&#x22;map&#x22;&#x3E;&#x3C;/div&#x3E;
&#x3C;/ion-content&#x3E;</code></pre>
                        <p>
                            and our scss <i>Don't forget the scss otherwise the google map will not be displayed.</i> </p>
                        <pre><code>.map {
  height: 100%;
}</code></pre>
                        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                        <!-- IonicDjangoBloc2 -->
                        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins>
                        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
                        <p> </p>
                    </section>                     
                    <ul class="pagination"> 
                        <li>
                            <a href="ionic-django-around-items.html" class="button">Prev</a>
                        </li>                         
                        <li>
                            <a href="#" class="page active">2</a>
                        </li>                         
                    </ul>                     
                    <section>
                        <div id="disqus_thread"></div>
                        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
                    </section>
                </div>
            </div>             
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="index.html">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Ionic and Signin with Apple",
      "description": "Learn to implement signin with Apple with Ionic",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>