<!DOCTYPE HTML> 
<!--
	Editorial by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--> 
<html> 
    <head> 
        <title>Design and setup Django project for a Ionic mobile application - Part 3</title>
        <meta name="description" content="We will learn how to design our database model and setup our django project/environment which will be used by our Ionic application."/>
        <meta name="author" content="surbier christophe">
        <meta charset="utf-8"/> 
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/> 
        <link rel="stylesheet" href="assets/css/main.css"/>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-125461829-1"></script>
        <script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-125461829-1');
</script>         
    </head>     
    <body class="is-preload"> 
        <!-- Wrapper -->         
        <div id="wrapper"> 
            <!-- Main -->             
            <div id="main"> 
                <div class="inner"> 
                    <!-- Header -->                     
                    <header id="header"> 
                        <a href="index.html" class="logo"><strong>Ionic and Django Tutorial</strong></a>
                        <ul class="icons">
                            <li>Share on 
                                <!-- AddToAny BEGIN -->
                                <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
                                    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
                                    <a class="a2a_button_facebook"></a>
                                    <a class="a2a_button_twitter"></a>
                                    <a class="a2a_button_linkedin"></a>
                                </div>
                                <script async src="https://static.addtoany.com/menu/page.js"></script>
                                <!-- AddToAny END -->                                 
                            </li>
                        </ul>                         
                    </header>                     
                    <!-- Content -->                     
                    <section> 
                        <header class="main"> 
                            <h1>Design and setup Django project for a Ionic application, part 3/3</h1>
                            <b>DAY 1 - September 2018</b>
                        </header>                         
                        <span class="image main"></span> 
                        <hr class="major"/> 
                        <h2 id="backoffice">Developing a Django backoffice for our ionic application</h2>
                        <br>
                        <p>
				  Ok so now it's time to implement our project with our <b>User</b> and <b>Bike</b> tables, and to setup our backoffice (web admin interface) 
				  to display, manipulate our data. <h3>Create django application</h3><br>To create our backoffice application, just write:</p>
                        <pre><code>python manage.py startapp backoffice</code></pre>
                        <p> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><!-- IonicDjangoBloc2 --><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="3940223516" data-ad-format="auto" data-full-width-responsive="true"></ins><script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script> </p>
                        <p>A new directory <b>backoffice</b> has been created with some files inside. We will edit the <b>models.py</b> file to create our <b>User and Bike</b> models:</p>
                        <pre><code>from django.db import models
from django.core.files import File
from django.contrib.auth.models import PermissionsMixin
from django.contrib.auth.base_user import AbstractBaseUser
from django.db import models
from django.contrib.gis.db import models
from django.contrib.gis.geos import Point
from backoffice.UserManager import UserManager
from django.contrib.auth.hashers import get_hasher, identify_hasher
import uuid
class User(AbstractBaseUser, PermissionsMixin):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    email = models.EmailField(unique=True,db_index=True)
    username = models.CharField(max_length=100, null=True, blank=True)
    facebookId = models.CharField(max_length=100, null=True, blank=True,db_index=True)
    android = models.BooleanField(blank=True, default=False)
    ios = models.NullBooleanField(blank=True, default=False, null=True)
    acceptPush = models.BooleanField(default=False)
    pushToken = models.CharField(max_length=100, null=True, blank=True,db_index=True)
    is_active = models.BooleanField(('active'), default=True)
    is_staff = models.BooleanField(('staff'), default=False)
    valid = models.BooleanField(default=True)
    objects = UserManager()
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []
    class Meta:
        verbose_name = ('User')
        verbose_name_plural = ('Users')
class Bike(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    reference = models.CharField(max_length=100,db_index=True)
    qrCode = models.CharField(max_length=100, null=True, blank=True, db_index=True)
    picture = models.ImageField(upload_to="media/%Y/%m/%d",null=True, blank=True)
    location = models.PointField(null=True, blank=True)
    available = models.BooleanField(default=True)
    valid = models.BooleanField(default=True)
    class Meta:
        verbose_name = ('Bike')
        verbose_name_plural = ('Bikes')</code></pre>
                        <p>Few remarks:</p>
                        <ul>
                            <li>we are extending the default Django User (please refer to 
                                <a href="https://simpleisbetterthancomplex.com/tutorial/2016/07/22/how-to-extend-django-user-model.html#abstractbaseuser" target="_blank">this blog</a>), 
                                because we will use the 
                                <b>email</b> in our application to authenticate the user.
                            </li>
                            <li>
                                We are using 
                                <b>UUID</b> as primary key to avoid future performance issues(and not default auto incremented key)
                            </li>
                        </ul>
                        <h3>Extend default django User model</h3>
                        <p>As we are extending the User model, we need to deal with the user creation (as explained in the previous link). So we create a new class <b>UserManager.py</b>:</p>
                        <pre><code>from django.contrib.auth.base_user import BaseUserManager
class UserManager(BaseUserManager):
    use_in_migrations = True
    def _create_user(self, email, password, **extra_fields):
        """
        Creates and saves a User with the given email and password.
        """
        if not email:
            raise ValueError('The given email must be set')
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user
    def create_user(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_superuser', False)
        return self._create_user(email, password, **extra_fields)
    def create_superuser(self, email, password, **extra_fields):
        extra_fields.setdefault('is_superuser', True)
        if extra_fields.get('is_superuser') is not True:
            raise ValueError('Superuser must have is_superuser=True.')
        return self._create_user(email, password, **extra_fields)</code> </pre>
                        <h3>Change password encryption algorithm</h3>
                        <p>Our next step is to deal with the authentification process. We will not use the default Django encryption system because it will take too much time for a mobile application 
 to encrypt or decrypt password (few seconds). Instead we will use <b>SHA256</b> encryption algorithm, which is strong enough for a mobile application. <br>Inside our <b>backoffice</b> directory, we will create a new python package called <b>libs</b> and will add a <b>hashers.py</b> file:</p>
                        <pre><code>import hashlib
from django.utils.translation import ugettext_noop as _
from django.contrib.auth.hashers import BasePasswordHasher, mask_hash
from django.utils.datastructures import OrderedDict
class SHA256PasswordHasher(BasePasswordHasher):
    algorithm = "sha256"
    def encode(self, password, salt, iterations=None):
        assert password is not None
        return hashlib.sha256(password.encode('utf-8')).hexdigest()
    def verify(self, password, encoded):
        return hashlib.sha256(password.encode('utf-8')).hexdigest() == encoded
    def safe_summary(self, encoded):
        algorithm, iterations, salt, hash = encoded.split('$', 3)
        return OrderedDict([
            (_('algorithm'), 'md5'),
            (_('hash'), mask_hash(hash)),
        ])</code></pre>
                        <p>Then in our <b>bikebackend</b> directory, we will edit the <b>settings.py</b> file to add:</p>
                        <pre><code>
#Custom User
AUTH_USER_MODEL = 'backoffice.User'
AUTHENTICATION_BACKENDS = (
    'django.contrib.auth.backends.ModelBackend',
    'backoffice.customAuthentification.customAuthentification',
)</code></pre>
                        <p>and in our <b>backoffice</b> directory, we will add the file <b>customAuthentification.py</b> to deal with the encryption/decryption process:</p>
                        <pre><code># -*-coding:utf-8 -*-
from django.contrib.auth.models import User
from .libs.hashers import *
from .models import User
class customAuthentification(object):
    """
    Use the login name and a hash of the password. For example:
    """
    def authenticate(self, username=None, password=None):
        if username:
            try:
                user = User.objects.get(username=username)
                encoder = SHA256PasswordHasher()
                if SHA256PasswordHasher.verify(encoder,password,user.password):
                    return user
                else:
                    return  None
            except User.DoesNotExist:
                return None
        return None
    def get_user(self, user_id):
        try:
            return User.objects.get(pk=user_id)
        except User.DoesNotExist:
            return None</code></pre>
                        <p>All these steps could seem a little bit difficult, but you don't need to know them perfectly. Just copy/paste the code each time you will begin a new Django project.
            The most important part is to focus on the <b>models.py</b> file to define our models and to the <b>admin.py</b> file which will be used to show our administration interface. <br>Before moving on this administration part, we will modify the <b>settings.py</b> file to indicate that we have added our <b>backoffice</b> application:</p>
                        <pre><code># Application definition
INSTALLED_APPS = [
    'backoffice.apps.BackofficeConfig', # <= this is the important line 'django.contrib.admin', 'django.contrib.auth', 'django.contrib.contenttypes', 'django.contrib.sessions', 'django.contrib.messages', 'django.contrib.staticfiles', ] < code></pre>
                        <p>Ok now it's time to deal with the administration interface.</p>
                        <h3>Django admin interface</h3>
                        <p>To display and administrate your models on the administration interface, edit the <b>admin.py</b> file and register them:</p>
                        <pre><code>from django.contrib import admin
# *coding: utf-8*
from django.contrib import admin
from .models import *
admin.site.register(User)
admin.site.register(Bike)</code></pre>
                        <p>That's it, nothing else to do.<br>So now we would like to access it, but we need to setup our database ! And at the moment, the Django project is setup with the default sqlite
 database, which is not compatible with our UUID primary key field.<br>
 So on the next coming tutorial day 2, we will configure and deploy our project in the cloud, and then enhance the admin interface a little bit. Stay tuned...</p>
                    </section>                     
                    <ul class="pagination"> 
                        <li>
                            <a href="design-and-setup-2.html" class="button">Prev</a>
                        </li>                         
                        <li>
                            <a href="design-and-setup.html" class="page">1</a>
                        </li>                         
                        <li>
                            <a href="design-and-setup-2.html" class="page">2</a>
                        </li>                         
                        <li>
                            <a href="#" class="page active">3</a>
                        </li>                         
                        <li>
                            <span class="button disabled">Next</span>
                        </li>                         
                    </ul>                     
                </div>
            </div>             
            <!-- Sidebar -->             
            <div id="sidebar"> 
                <div class="inner"> 
                    <!-- Menu -->                     
                    <nav id="menu"> 
                        <header class="major"> 
                            <h2>Menu</h2> 
                        </header>                         
                        <ul> 
                            <li>
                                <a href="index.html">Homepage</a>
                            </li>                             
                            <li>
                                <a href="terms.html">Terms and conditions</a>
                            </li>
                            <li>
                                <a href="policy.html">Privacy Policy</a>
                            </li>                             
                        </ul>                         
                    </nav>                     
                    <!-- Section -->                     
                    <section> 
                        <header class="major"> 
                            <h2>Get in touch</h2> 
                        </header>                         
                        <p>For any questions, remarks or any development requirement.</p> 
                        <ul class="contact"> 
                            <li class="fa-envelope-o">
                                <a href="mailto:csurbier@idevotion.fr">csurbier@idevotion.fr</a>
                            </li>                             
                            <li class="fa-home">Carrer Riera blanca, 45-47
                                <br/> 
                                08028 Barcelona
                            </li>                             
                        </ul>                         
                    </section>                     
                    <!-- Footer -->                     
                    <footer id="footer"> 
                        <p class="copyright">&copy; Surbier Christophe. All rights reserved. Development: <a href="https://www.idevotion.fr">iDevotion</a>. Design: <a href="https://html5up.net">HTML5 UP</a>.</p> 
                    </footer>                     
                </div>                 
            </div>             
        </div>         
        <!-- Scripts -->         
        <script src="assets/js/jquery.min.js"></script>         
        <script src="assets/js/browser.min.js"></script>         
        <script src="assets/js/breakpoints.min.js"></script>         
        <script src="assets/js/util.js"></script>         
        <script src="assets/js/main.js"></script>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-5248722664237652" data-ad-slot="8488918554" data-ad-format="auto" data-full-width-responsive="true"></ins>
        <script>
(adsbygoogle = window.adsbygoogle || []).push({});
</script>
        <div id="disqus_thread"></div>
        <script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT 
     *  THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR 
     *  PLATFORM OR CMS.
     *  
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: 
     *  https://disqus.com/admin/universalcode/#configuration-variables
     */
    var disqus_config = function () {
        // Replace PAGE_URL with your page's canonical URL variable
        this.page.url = "https://www.ionicanddjangotutorial.com/design-and-setup.html";  
        
        // Replace PAGE_IDENTIFIER with your page's unique identifier variable
        this.page.identifier = "dayone-designsetup"; 
    };
    
    (function() {  // REQUIRED CONFIGURATION VARIABLE: EDIT THE SHORTNAME BELOW
        var d = document, s = d.createElement('script');
        
        // IMPORTANT: Replace EXAMPLE with your forum shortname!
        s.src = 'https://https-www-ionicanddjangotutorial-com.disqus.com/embed.js'
        
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
        <noscript>
            Please enable JavaScript to view the 
            <a href="https://disqus.com/?ref_noscript" rel="nofollow">
        comments powered by Disqus. </a>
        </noscript>         
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Organization",
      "url": "https://www.ionicanddjangotutorial.com",
      "contactPoint": [{
        "@type": "ContactPoint",
        "email": "csurbier@idevotion.fr",
        "contactType": "customer support"
      }]
    }
  </script>
        <script type="application/ld+json">
    {
      "@context": "http://schema.org",
      "@type": "Course",
      "name": "Ionic and Django tutorial",
      "description": "A tutorial to learn mobile application development from scratch and on a concrete use case, using Ionic 4 as frontend and Django as backend.",
      "provider": {
        "@type": "Organization",
        "name": "iDevotion",
        "sameAs": "https://www.ionicanddjangotutorial.com"
      }
    }
  </script>
    </body>     
</html>